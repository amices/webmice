---
title: WEBMICE - 
subtitle: webmice 0.0.1 (December 2023)
author: 
output:
  html_document:
  number_sections: false
  self-contained: true
theme: united
editor_options: 
  chunk_output_type: console
---
<!-- README.md is generated from README.Rmd. Please edit that file -->
  
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache = FALSE)
```

## Overview

WEBMICE is a web service for imputing and analysing incomplete datasets. WEBMICE provides a language-independent API to the functionality of the MICE R package. 
It can 

1. read data from local system of the client;
2. create multiple complete versions from incomplete data;
3. analyse each of the imputed datasets;
4. pool the analyses results into one result.

WEBMICE is a RESTful API that runs on a (remote) host. In principle, any `HTTP` client will work with WEBMICE. The following sections illustrate how a client can make requests to WEBMICE using various client languages. 

### Primary WEBMICE end points

| Verb  | API end point              | Description                                | Maps to `R` function     |
|:------|:-------------------------- |:------------------------------------------ |:-------------------------|
| POST  | `/data`                    | Upload incomplete data                     |                          |
| GET   | `/version`                 | Get version number of `mice` package       | `utils::packageVersion()`|
| ...   |                            |                                            |                          |

The table lists the defined API end points and the internal mapping between the API end point and the corresponding R function. 

### Objective

This document provides a quick introduction into the main WEBMICE features, and how these can be assessed from `R` and from the bash command line.


## Features 

### {.tabset}

#### **R**

##### **`/version`**: Obtain version information

Let us first check whether WEBMICE is running. The following code makes a simple request to WEBMICE to see whether it is alive and to return the version number of the underlying `mice` R package. We illustrate both requests in `R` and in `bash`.

We first need to install and load packages.

```{r httr, eval=FALSE}
install.packages(c("httr2", "jsonlite"))
```
```{r load}
library(httr2)
library(jsonlite)
```

Let's find out the WEBMICE version number. In this document, we define the server that hosts WEBMICE as follows, and optionally create a variable `.host` for use in the bash terminal.

```{r host}
host <- "http://localhost:8080"
```

We first illustrate a method that makes a request to the server. The following command prepares a GET request `req` to the `/version` end point:

```{r req_version}
req <- request(host) |> 
  req_headers(accept = "text/plain") |> 
  req_url_path("/version")
req
```

The next step sends the request to the API server, and stores the result in the server response `resp`:

```{r call_version}
resp <- req_perform(req)
resp
```

The next step parses the `resp` object and converts the body into an R list:

```{r ret_version}
ret <- resp |> 
  resp_body_string() |> 
  fromJSON()
ret
```

See the documentation of the `httr2` package for other operations and extractions. One may chain the above operations as:

```{r}
request(host) |> 
  req_headers(accept = "text/plain") |> 
  req_url_path("/version") |> 
  req_perform() |> 
  resp_body_string() |> 
  fromJSON()
```

##### **`/long`**: Impute built-in dataset

Raw call

```{r}
resp <- request("http://localhost:8080/long?payload=%7B%22data%22%3A%22nhanes%22%2C%22maxit%22%3A2%2C%22m%22%3A2%2C%22seed%22%3A1%7D") %>% 
  req_method("GET") %>% 
  req_headers(accept = "text/json") %>% 
  req_perform()
ret <- resp |> 
  resp_body_string() |> 
  fromJSON()
head(ret$result)
```

A more user-friendly call

```{r, eval=TRUE}
req <- request(host) |> 
  req_headers(accept = "text/json") |> 
  req_url_path("/long") |> 
  req_url_query(payload = '{"data":"nhanes","maxit":2,"m":1,"seed":1}')
req |> req_dry_run()
resp <- req_perform(req)
ret <- resp |> 
  resp_body_string() |> 
  fromJSON()
head(ret$result)
```

##### **`/data`**: Upload data

Uploading data to WEBMICE can be done by sending a text file. Suppose that `../testdata/tempdata.csv` is a comma-delimited file with data. We may upload it as

```{r upload_r, eval = TRUE}
input <- curl::form_file("../testdata/tempdata.csv", type = "text/csv")
#input <- curl::form_file("testdata/tempdata.csv", type = "text/csv")
resp <- request(host) |> 
  req_url_path("/data") |> 
  req_headers("accept" = "text/plain", 
              "content-type" = "multipart/form-data") |>
  req_body_multipart(csvfile = input) |> 
  req_perform()
resp_header(resp, "data_token")
```

The file is uploaded to the server. The `data_token` header may be used for subsequent requests to refer to the uploaded data.

##### **`/long`**: Impute data using the token (not yet working)

```{r impute_r, eval=TRUE}
token <- resp_header(resp, "data_token")
req <- request(host) |> 
  req_url_path("/long") |> 
  req_url_query(payload = paste0('{"data":', token, ',"maxit":2,"m":1,"seed":1}')) |> 
  req_headers("accept" = "text/json")
req_dry_run(req)
resp <- req |> req_perform()
ret <- resp |> 
  resp_body_string() |> 
  fromJSON()
ret
```


#### **bash**

##### **`/version`**: Obtain version information

We use the `curl` Linux command. If needed, on Ubuntu install `curl` as

```{bash, eval=FALSE}
sudo apt update
sudo apt -y install curl
```

Letâ€™s find out the WEBMICE version number. We first illustrate a method that makes two requests to the server.

The following `bash` commands call the `/version` API end point with a GET request, and stores the response in file `resp`:

```{bash get_version}
echo http://localhost:8080 > .host
curl -X 'GET' \
  $(cat .host)/version \
  -H 'accept: text/plain' \
  > resp
```

The response to the request consists of a set of URLs created on the server, each of which contains details on the response. 

```{bash}
cat resp
```

##### **exampledata**: Get example data

The R package `mice` contains a few built-in datasets (See <https://amices.org/mice/reference/index.html#datasets>). These datasets can be imputed and analysed directly on the server. To download the JSON representation of the `mice::boys` data and store it in file `boys.json` use

```{bash exampledata_bash}
curl -X 'GET' \
    $(cat .host)/exampledata?name=boys \
    -H 'accept: text/json' \
    > boys.json
```

##### **`/data`**: Upload data

Uploading data to WEBMICE can be done by sending a text file. Suppose that `../testdata/tempdata.csv` is a comma-delimited file with data. We may upload it as

```{bash upload_bash, eval = TRUE}
curl -X 'POST' \
  $(cat .host)/data \
  -H 'accept: text/plain' \
  -H 'Content-Type: multipart/form-data' \
  -F 'csvfile=@../testdata/tempdata.csv;type=text/csv' \
  -v > /dev/null
```

The file is uploaded to the server. The `data_token` header may be used for subsequent requests to refer to the uploaded data.

##### **`/long`**: Impute built-in dataset

Raw call

```{bash}
curl -X 'GET' \
  'http://localhost:8080/long?payload=%7B%22data%22%3A%22boys%22%2C%22maxit%22%3A2%2C%22m%22%3A2%2C%22seed%22%3A1%7D' \
  -H 'accept: text/json' > boys_imputed_1.json
```

A more user-friendly call (does not work)

```{bash, eval=FALSE}
curl -X 'GET' \
  $(cat .host)/long?payload='{"data":"nhanes","maxit":2,"m":1,"seed":1}' \
  -H 'accept: text/json' > boys_imputed_2.json
```

### {-}

## Resources

### Internal

| Description                                           | Status                                  |
|:------------------------------------------------------|:----------------------------------------|

### External
  
| Description                                           | Status                                  |
|:------------------------------------------------------|:----------------------------------------|
